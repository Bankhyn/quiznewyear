<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StockManday Drill (Ultimate)</title>
  <style>
    /* ‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Scrollbar */
    body { 
      background: #f4f4f4; 
      margin: 0; 
      padding: 0; 
      font-family: 'Sarabun', sans-serif; 
      text-align: center; 
      touch-action: manipulation;
      height: 100vh; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
      display: flex;
      flex-direction: column;
      justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      align-items: center;
      overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar */
    }
    
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ: ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 70% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ */
    #game-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
      max-height: 70vh; /* ‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 70% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á */
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* ‡∏ï‡∏±‡∏ß‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
    img.quiz-bg {
      display: block;
      height: auto;
      width: auto;
      max-height: 70vh; /* ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 70% */
      max-width: 100%;  /* ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
      cursor: crosshair; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á */
    }

    /* Canvas (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ß‡∏≤‡∏î) ‡∏ó‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏û‡∏≠‡∏î‡∏µ */
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ß‡∏≤‡∏î */
      cursor: crosshair;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö */
    #answer-box {
      width: 90%;
      max-width: 600px;
      margin-top: 15px; 
      padding: 10px 15px; 
      background: white;
      border-radius: 10px; 
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
      font-size: 16px;
      z-index: 10;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ */
    button {
      padding: 10px 20px; font-size: 16px;
      background: #3480d4; color: white; border: none; border-radius: 8px;
      margin-top: 8px; cursor: pointer; width: 100%;
    }
    button:active { transform: scale(0.98); }
    
    .status { margin-top: 5px; font-weight: bold; font-size: 16px; min-height: 24px; }
    .correct { color: #28a745; }
    .wrong { color: #dc3545; }
    
    select { padding: 8px; font-size: 16px; width: 100%; border-radius: 5px; border: 1px solid #ccc; margin-top: 5px;}
    .question-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px;}
  </style>
</head>
<body>

<div id="game-container">
  <img src="quizhappynewyear.png" class="quiz-bg" id="bgImage">
  <canvas id="quizCanvas"></canvas>
</div>

<div id="answer-box">
  <div id="questionText" class="question-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <div class="status" id="resultStatus"></div>
  
  <div id="actionButtons">
      <button id="nextBtn" onclick="checkAnswer()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
  </div>
  
  <div id="removePanel" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
    <div style="text-align:left; margin-bottom:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö:</div>
    <select id="removeSelector"></select>
    <button onclick="confirmRemove()" style="background:#dc3545;">üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏µ‡πâ</button>
  </div>
</div>

<script>
// ======================================================
// 1. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏à‡∏ó‡∏¢‡πå (‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å Builder ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
// ======================================================
const steps = [
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏π‡∏ö‡∏ì‡πå‡∏ä‡∏∏‡∏î‡∏ï‡πâ‡∏ô‡∏£‡∏≠‡∏ö",
    "type": "down",
    "answer": {
      "x1": 454,
      "y1": 152,
      "x2": 502,
      "y2": 91
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": {
      "x1": 679,
      "y1": 289,
      "x2": 695,
      "y2": 198
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8 ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÄ‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö DIVERGENCE (ADVANCE)",
    "type": "vertical",
    "answerX": 753
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8",
    "type": "remove",
    "removeIndex": 1
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤ (‡∏ï‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô)",
    "type": "down",
    "answer": {
      "x1": 754,
      "y1": 331,
      "x2": 1054,
      "y2": 207
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡∏ä‡∏∏‡∏î‡∏ï‡πâ‡∏ô‡∏£‡∏≠‡∏ö",
    "type": "vertical",
    "answerX": 1326
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 0
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": {
      "x1": 1528,
      "y1": 495,
      "x2": 1593,
      "y2": 430
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8 ‡πÅ‡∏•‡∏∞ RSI ‡∏à‡∏ö‡∏£‡∏≠‡∏ö",
    "type": "vertical",
    "answerX": 1623
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô161.8 ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤",
    "type": "remove",
    "removeIndex": 5
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤",
    "type": "up",
    "answer": {
      "x1": 1671,
      "y1": 394,
      "x2": 1745,
      "y2": 462
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
    "type": "down",
    "answer": {
      "x1": 2121,
      "y1": 435,
      "x2": 2187,
      "y2": 359
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢",
    "type": "vertical",
    "answerX": 2032
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢",
    "type": "remove",
    "removeIndex": 7
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": {
      "x1": 2467,
      "y1": 671,
      "x2": 2486,
      "y2": 594
    }
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8 RSI ‡∏à‡∏ö‡∏£‡∏≠‡∏ö",
    "type": "vertical",
    "answerX": 2687
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 8
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8 ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 10
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏ä‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
    "type": "down",
    "answer": {
      "x1": 2687,
      "y1": 698,
      "x2": 2716,
      "y2": 614
    }
  }
];

// ======================================================
// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏° Core Engine
// ======================================================
const canvas = document.getElementById('quizCanvas');
const ctx = canvas.getContext('2d');
const bgImage = document.getElementById('bgImage');

let currentStepIdx = 0;
let userLines = []; 
let isDrawing = false;
let startX=0, startY=0;
let tempLine = null;
let scaleX = 1, scaleY = 1;

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Crosshair
let mouseX = 0, mouseY = 0;
let showCrosshair = false;

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏£‡∏≠‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
bgImage.onload = function() {
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î
  canvas.width = bgImage.naturalWidth;
  canvas.height = bgImage.naturalHeight;
  showStep();
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î (Scale) ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
function getCoords(e) {
  const rect = canvas.getBoundingClientRect();
  scaleX = canvas.width / rect.width;
  scaleY = canvas.height / rect.height;

  let clientX, clientY;
  if (e.touches && e.touches.length > 0) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  return {
    x: (clientX - rect.left) * scaleX,
    y: (clientY - rect.top) * scaleY
  };
}

// --- Event Listeners (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Mouse ‡πÅ‡∏•‡∏∞ Touch) ---
canvas.addEventListener('mousedown', onStart);
canvas.addEventListener('touchstart', onStart, {passive: false});
canvas.addEventListener('mousemove', onMove);
canvas.addEventListener('touchmove', onMove, {passive: false});
canvas.addEventListener('mouseup', onEnd);
canvas.addEventListener('touchend', onEnd);
canvas.addEventListener('mouseleave', () => {
    showCrosshair = false;
    draw();
});

function onStart(e) {
  if (e.cancelable) e.preventDefault(); // ‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
  const coords = getCoords(e);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Crosshair
  mouseX = coords.x; mouseY = coords.y; showCrosshair = true;
  startX = coords.x; startY = coords.y;

  const s = steps[currentStepIdx];
  if (s.type === 'remove') {
      draw(); return;
  }

  if (s.type === 'vertical') {
    tempLine = { type: 'vertical', x: startX };
  } else {
    isDrawing = true;
    tempLine = null;
  }
  draw();
}

function onMove(e) {
  if (e.cancelable) e.preventDefault();
  const coords = getCoords(e);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Crosshair
  mouseX = coords.x; mouseY = coords.y; showCrosshair = true;

  if (isDrawing) {
      const s = steps[currentStepIdx];
      tempLine = {
        type: s.type,
        x1: startX, y1: startY,
        x2: coords.x, y2: coords.y
      };
  }
  draw();
}

function onEnd() { 
    isDrawing = false; 
    draw();
}

// --- Main Render Function ---
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // 1. ‡∏ß‡∏≤‡∏î Crosshair (‡∏ä‡∏±‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î)
  if(showCrosshair) drawCrosshair();

  // 2. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Å‡πà‡∏≤ (History)
  userLines.forEach((line, idx) => {
    if(!line.removed) drawSingleLine(line, false, idx + 1);
  });
  
  // 3. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Preview)
  if (tempLine) drawSingleLine(tempLine, true);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á
function drawCrosshair() {
    ctx.beginPath();
    ctx.strokeStyle = '#666'; 
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 5]); 
    ctx.moveTo(mouseX, 0); ctx.lineTo(mouseX, canvas.height); // ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
    ctx.moveTo(0, mouseY); ctx.lineTo(canvas.width, mouseY); // ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
    ctx.stroke();
    ctx.setLineDash([]); 
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
function drawSingleLine(line, isPreview, labelIndex=null) {
  ctx.lineWidth = isPreview ? 2 : 4; 
  
  // Case 1: Vertical Line
  if (line.type === 'vertical') {
    ctx.beginPath();
    ctx.moveTo(line.x, 0); ctx.lineTo(line.x, canvas.height);
    ctx.strokeStyle = isPreview ? '#007bff' : '#6f42c1'; 
    ctx.setLineDash([10, 5]);
    ctx.stroke();
    ctx.setLineDash([]);
    return;
  }

  // Case 2: Fibo Line
  const isDown = line.type === 'down';
  const mainColor = isDown ? '#dc3545' : '#28a745'; 
  
  // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å
  ctx.beginPath();
  ctx.moveTo(line.x1, line.y1); ctx.lineTo(line.x2, line.y2);
  ctx.strokeStyle = isPreview ? (isDown ? 'rgba(220,53,69,0.5)' : 'rgba(40,167,69,0.5)') : mainColor;
  ctx.setLineDash([]);
  ctx.stroke();

  // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢
  ctx.fillStyle = mainColor;
  ctx.beginPath(); ctx.arc(line.x2, line.y2, isPreview? 4:6, 0, Math.PI*2); ctx.fill();

  // ‡∏ß‡∏≤‡∏î Fibo Levels
  const levels = [0, 1, 1.272, 1.618, 2, 2.618, 4.236]; 
  
  levels.forEach(lvl => {
    let yLevel;
    if (isDown) yLevel = line.y2 + (line.y1 - line.y2) * lvl;
    else yLevel = line.y2 - (line.y2 - line.y1) * lvl;

    ctx.beginPath();
    ctx.moveTo(line.x2 - 30, yLevel); ctx.lineTo(line.x2 + 80, yLevel); 
    ctx.strokeStyle = mainColor;
    ctx.lineWidth = 1.5;
    
    // ‡πÄ‡∏™‡πâ‡∏ô 100% ‡∏Å‡∏±‡∏ö 161.8% ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö ‡∏ô‡∏≠‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
    if(lvl === 1 || lvl === 1.618) ctx.setLineDash([]); else ctx.setLineDash([4, 4]);
    ctx.stroke();
    
    // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö)
    ctx.fillStyle = mainColor;
    ctx.font = isPreview ? "12px Arial" : "bold 14px Arial";
    let text = (lvl * 100).toFixed(1); 
    if (text.endsWith('.0')) text = text.replace('.0', '');
    ctx.fillText(text, line.x2 + 5, yLevel - 5); 
  });
  ctx.setLineDash([]);

  // Label ‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≠
  if(labelIndex !== null) {
      const midX = (line.x1+line.x2)/2;
      const midY = (line.y1+line.y2)/2 - 20;
      ctx.save();
      ctx.globalAlpha = 0.8; ctx.fillStyle = 'white';
      ctx.fillRect(midX - 15, midY - 25, 30, 30);
      ctx.restore();
      ctx.fillStyle = 'black'; ctx.font = "bold 30px Arial";
      ctx.fillText(labelIndex, midX - 8, midY); 
  }
}

// Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
function checkAnswer() {
  const s = steps[currentStepIdx];
  if(!tempLine) {
       document.getElementById('resultStatus').innerHTML = "<span style='color:#e67e22'>‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</span>";
       return;
  }

  const marginY = 40; 
  const marginVert = 50; 
  let isCorrect = false;
  
  if (s.type === 'vertical') {
     if(Math.abs(tempLine.x - s.answerX) < marginVert) isCorrect = true;
  } else {
     if(Math.abs(tempLine.y1 - s.answer.y1) < marginY && 
        Math.abs(tempLine.y2 - s.answer.y2) < marginY) isCorrect = true;
  }

  if (isCorrect) {
    document.getElementById('resultStatus').innerHTML = "<span class='correct'>‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</span>";
    userLines.push({...tempLine, removed: false});
    tempLine = null;
    draw();
    setTimeout(() => { currentStepIdx++; showStep(); }, 1000);
  } else {
    document.getElementById('resultStatus').innerHTML = "<span class='wrong'>‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞</span>";
  }
}

function showStep() {
  if(currentStepIdx >= steps.length) {
      document.getElementById('questionText').innerText = "üéâ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å";
      document.getElementById('actionButtons').style.display = 'none';
      document.getElementById('removePanel').style.display = 'none';
      document.getElementById('resultStatus').innerText = "";
      return;
  }
  
  const s = steps[currentStepIdx];
  document.getElementById('questionText').innerText = s.question;
  document.getElementById('resultStatus').innerText = "";
  tempLine = null;
  draw();

  if (s.type === 'remove') {
    document.getElementById('removePanel').style.display = 'block';
    document.getElementById('nextBtn').style.display = 'none';
    const sel = document.getElementById('removeSelector');
    sel.innerHTML = "";
    userLines.forEach((l, i) => {
       if(!l.removed) sel.innerHTML += `<option value="${i}">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà ${i+1} (${l.type.toUpperCase()})</option>`;
    });
  } else {
    document.getElementById('removePanel').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-block';
  }
}

function confirmRemove() {
    const idx = parseInt(document.getElementById('removeSelector').value);
    const s = steps[currentStepIdx];
    if (idx === s.removeIndex) {
        userLines[idx].removed = true;
        document.getElementById('resultStatus').innerHTML = "<span class='correct'>‚úÖ ‡∏•‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</span>";
        draw();
        setTimeout(() => { currentStepIdx++; showStep(); }, 1000);
    } else {
        document.getElementById('resultStatus').innerHTML = "<span class='wrong'>‚ùå ‡∏•‡∏ö‡∏ú‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô!</span>";
    }
}
</script>
</body>
</html>
