<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StockManday Drill (Filter Remove)</title>
  <style>
    /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å */
    body { 
      background: #222; 
      margin: 0; padding: 0; 
      font-family: 'Sarabun', sans-serif; 
      overflow: hidden; 
      width: 100vw; height: 100vh;
      display: flex; flex-direction: column;
    }

    /* ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠ */
    #rotate-warning {
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      width: 100%; height: 100%;
      background: #1a1a1a; color: white;
      text-align: center; z-index: 9999;
      position: absolute; top: 0; left: 0;
    }
    .rotate-icon { font-size: 50px; margin-bottom: 20px; }

    /* Wrapper ‡∏£‡∏ß‡∏° */
    #game-wrapper {
      display: none; 
      width: 100%; height: 100%;
      flex-direction: column;
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü (Flexible) --- */
    #game-container {
      position: relative;
      width: 100%; 
      flex: 1; 
      background: #333; 
      overflow: hidden;
      display: flex;
      justify-content: center; 
      align-items: flex-end;   
    }

    /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô */
    #chart-box {
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    img.quiz-bg {
      display: block;
      width: 100%; height: 100%;
    }

    canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      touch-action: none; cursor: crosshair;
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Fixed Bottom) --- */
    #control-area {
      width: 100%;
      height: auto; min-height: 80px; 
      background: #f8f9fa;
      border-top: 1px solid #444;
      display: flex; align-items: center; justify-content: center;
      padding: 10px; box-sizing: border-box;
      z-index: 100;
    }

    #answer-box {
      width: 95%; max-width: 800px;
      display: flex; flex-direction: row; 
      align-items: center; justify-content: space-between;
      gap: 15px;
    }

    .question-section { flex: 2; text-align: left; }
    .action-section { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap:10px;}

    .question-title { 
      font-size: 16px; font-weight: bold; color: #333; margin: 0; 
    }

    button.action-btn {
      padding: 10px 25px; font-size: 16px; font-weight: bold;
      background: #3480d4; color: white; border: none; border-radius: 8px;
      cursor: pointer; white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    button.action-btn:active { transform: scale(0.96); }

    .status { font-weight: bold; font-size: 20px; min-width: 30px; text-align:center;}
    .correct { color: #28a745; } .wrong { color: #dc3545; }
    
    #removePanel { display: none; align-items: center; gap: 5px; }
    select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px;}

    @media (orientation: landscape) {
      #rotate-warning { display: none !important; }
      #game-wrapper { display: flex !important; }
    }
  </style>
</head>
<body>

<div id="rotate-warning">
  <div class="rotate-icon">üîÑ</div>
  <h2>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</h2>
</div>

<div id="game-wrapper">
  
  <div id="game-container">
    <div id="chart-box">
      <img src="quizhappynewyear.png" class="quiz-bg" id="bgImage">
      <canvas id="quizCanvas"></canvas>
    </div>
  </div>

  <div id="control-area">
    <div id="answer-box">
      <div class="question-section">
          <div id="questionText" class="question-title">Loading...</div>
      </div>
      <div class="action-section">
          <div class="status" id="resultStatus"></div>
          <div id="mainActions">
              <button id="nextBtn" class="action-btn" onclick="checkAnswer()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
          </div>
          <div id="removePanel">
            <select id="removeSelector"></select>
            <button onclick="confirmRemove()" class="action-btn" style="background:#dc3545;">‡∏•‡∏ö</button>
          </div>
      </div>
    </div>
  </div>

</div>

<script>
// ======================================================
// 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
// ======================================================
const startVisible = 800; 
const defaultOffset = 200; 
const maskColor = "#ffffff"; 

// ======================================================
// 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏à‡∏ó‡∏¢‡πå
// ======================================================
const steps = [
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏π‡∏ö‡∏ì‡πå‡∏ä‡∏∏‡∏î‡∏ï‡πâ‡∏ô‡∏£‡∏≠‡∏ö",
    "type": "down",
    "answer": { "x1": 460, "y1": 154, "x2": 501, "y2": 91 },
    "revealLimit": 624
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": { "x1": 679, "y1": 289, "x2": 695, "y2": 198 },
    "revealLimit": 854
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8 ",
    "type": "vertical",
    "answerX": 755,
    "revealLimit": 1252
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 161.8",
    "type": "remove",
    "removeIndex": 1,
    "revealLimit": 1345
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤ (‡∏ï‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô)",
    "type": "down",
    "answer": { "x1": 753, "y1": 335, "x2": 1056, "y2": 209 },
    "revealLimit": 1627
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡∏ä‡∏∏‡∏î‡∏ï‡πâ‡∏ô‡∏£‡∏≠‡∏ö",
    "type": "vertical",
    "answerX": 1326,
    "revealLimit": 1625
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 0,
    "revealLimit": 1632
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": { "x1": 1527, "y1": 492, "x2": 1594, "y2": 435 },
    "revealLimit": 1839
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢",
    "type": "vertical",
    "answerX": 1626,
    "revealLimit": 1840
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡∏ß‡∏±‡∏î",
    "type": "remove",
    "removeIndex": 5,
    "revealLimit": 2025
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤",
    "type": "up",
    "answer": { "x1": 1672, "y1": 389, "x2": 1751, "y2": 466 },
    "revealLimit": 2024
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
    "type": "down",
    "answer": { "x1": 2119, "y1": 435, "x2": 2195, "y2": 358 },
    "revealLimit": 2469
  },
  {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢",
    "type": "vertical",
    "answerX": 2025,
    "revealLimit": 2474
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢",
    "type": "remove",
    "removeIndex": 7,
    "revealLimit": 2705
  },
    {
    "question": "‡∏à‡∏á‡∏ï‡∏±‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å",
    "type": "vertical",
    "answerX": 2466,
    "revealLimit": 2844
  },
  {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 8
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á",
    "type": "down",
    "answer": { "x1": 2589, "y1": 652, "x2": 2636, "y2": 599 },
    "revealLimit": 2771
  },
  {
    "question": "‡∏à‡∏á‡∏ß‡∏≤‡∏î‡∏ü‡∏¥‡πÇ‡∏ö‡∏Ç‡∏≤‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏Å‡∏Ñ‡∏≠",
    "type": "down",
    "answer": { "x1": 2689, "y1": 701, "x2": 2767, "y2": 616 }
  },
    {
    "question": "‡∏à‡∏á‡∏•‡∏ö‡∏ü‡∏¥‡πÇ‡∏ö‡∏†‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
    "type": "remove",
    "removeIndex": 3
  }
];

// ======================================================
// 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏° (Core Engine)
// ======================================================
const canvas = document.getElementById('quizCanvas');
const ctx = canvas.getContext('2d');
const bgImage = document.getElementById('bgImage');
const chartBox = document.getElementById('chart-box');
const gameContainer = document.getElementById('game-container');

let currentStepIdx = 0;
let userLines = []; 
let isDrawing = false;
let startX=0, startY=0;
let tempLine = null;
let scaleX = 1, scaleY = 1;
let mouseX = 0, mouseY = 0;
let showCrosshair = false;

bgImage.onload = function() {
  resizeChart(); 
  window.addEventListener('resize', resizeChart);
  showStep();
};

function resizeChart() {
  const containerW = gameContainer.clientWidth;
  const containerH = gameContainer.clientHeight;
  const imgW = bgImage.naturalWidth;
  const imgH = bgImage.naturalHeight;
  const ratio = Math.min(containerW / imgW, containerH / imgH);
  const newW = imgW * ratio;
  const newH = imgH * ratio;
  chartBox.style.width = newW + 'px';
  chartBox.style.height = newH + 'px';
  canvas.width = imgW;
  canvas.height = imgH;
  draw();
}

function getCoords(e) {
  const rect = canvas.getBoundingClientRect();
  scaleX = canvas.width / rect.width;
  scaleY = canvas.height / rect.height;
  let clientX, clientY;
  if (e.touches && e.touches.length > 0) {
    clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX; clientY = e.clientY;
  }
  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

canvas.addEventListener('mousedown', onStart);
canvas.addEventListener('touchstart', onStart, {passive: false});
canvas.addEventListener('mousemove', onMove);
canvas.addEventListener('touchmove', onMove, {passive: false});
canvas.addEventListener('mouseup', onEnd);
canvas.addEventListener('touchend', onEnd);
canvas.addEventListener('mouseleave', () => { showCrosshair = false; draw(); });

function onStart(e) {
  if (e.cancelable) e.preventDefault();
  const coords = getCoords(e);
  mouseX = coords.x; mouseY = coords.y; showCrosshair = true;
  startX = coords.x; startY = coords.y;

  if(startX > getRevealLimit()) return; 

  const s = steps[currentStepIdx];
  if (s.type === 'remove') { draw(); return; }

  if (s.type === 'vertical') { tempLine = { type: 'vertical', x: startX }; }
  else { isDrawing = true; tempLine = null; }
  draw();
}

function onMove(e) {
  if (e.cancelable) e.preventDefault();
  const coords = getCoords(e);
  mouseX = coords.x; mouseY = coords.y; showCrosshair = true;
  if (isDrawing) {
      const s = steps[currentStepIdx];
      tempLine = { type: s.type, x1: startX, y1: startY, x2: coords.x, y2: coords.y };
  }
  draw();
}

function onEnd() { isDrawing = false; draw(); }

function getRevealLimit() {
  if(currentStepIdx >= steps.length) return canvas.width;
  if(steps[currentStepIdx].revealLimit !== undefined) {
      return steps[currentStepIdx].revealLimit;
  }
  let maxX = 0;
  for(let i=0; i < currentStepIdx; i++) {
     const s = steps[i];
     if(s.revealLimit) maxX = Math.max(maxX, s.revealLimit);
     if(s.type === 'vertical') maxX = Math.max(maxX, s.answerX);
     else if (s.type === 'up' || s.type === 'down') maxX = Math.max(maxX, s.answer.x1, s.answer.x2);
  }
  return Math.max(startVisible, maxX + defaultOffset);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const limitX = getRevealLimit();

  if(showCrosshair && mouseX < limitX) drawCrosshair();

  userLines.forEach((line, idx) => { if(!line.removed) drawSingleLine(line, false, idx + 1); });
  if (tempLine) drawSingleLine(tempLine, true);

  if(limitX < canvas.width) {
      ctx.fillStyle = maskColor;
      ctx.fillRect(limitX, 0, canvas.width - limitX, canvas.height);
      ctx.beginPath();
      ctx.moveTo(limitX, 0); ctx.lineTo(limitX, canvas.height);
      ctx.strokeStyle = "#888"; ctx.lineWidth = 2; ctx.setLineDash([10,10]);
      ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle = "#aaa"; ctx.font = "bold 20px Arial";
      ctx.fillText("Waiting...", limitX + 20, 50);
  }
}

function drawCrosshair() {
    ctx.beginPath();
    ctx.strokeStyle = '#999'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]); 
    ctx.moveTo(mouseX, 0); ctx.lineTo(mouseX, canvas.height); 
    ctx.moveTo(0, mouseY); ctx.lineTo(canvas.width, mouseY); 
    ctx.stroke(); ctx.setLineDash([]); 
}

function drawSingleLine(line, isPreview, labelIndex=null) {
  ctx.lineWidth = isPreview ? 3 : 5; 
  if (line.type === 'vertical') {
    ctx.beginPath(); ctx.moveTo(line.x, 0); ctx.lineTo(line.x, canvas.height);
    ctx.strokeStyle = isPreview ? '#007bff' : '#6f42c1'; 
    ctx.setLineDash([10, 5]); ctx.stroke(); ctx.setLineDash([]); return;
  }
  const isDown = line.type === 'down';
  const mainColor = isDown ? '#dc3545' : '#28a745'; 
  ctx.beginPath(); ctx.moveTo(line.x1, line.y1); ctx.lineTo(line.x2, line.y2);
  ctx.strokeStyle = isPreview ? (isDown ? 'rgba(220,53,69,0.5)' : 'rgba(40,167,69,0.5)') : mainColor;
  ctx.setLineDash([]); ctx.stroke();
  ctx.fillStyle = mainColor; ctx.beginPath(); ctx.arc(line.x2, line.y2, isPreview? 5:8, 0, Math.PI*2); ctx.fill();

  const levels = [0, 1, 1.272, 1.618, 2, 2.618, 4.236]; 
  levels.forEach(lvl => {
    let yLevel = isDown ? line.y2 + (line.y1 - line.y2) * lvl : line.y2 - (line.y2 - line.y1) * lvl;
    ctx.beginPath(); ctx.moveTo(line.x2 - 30, yLevel); ctx.lineTo(line.x2 + 80, yLevel); 
    ctx.strokeStyle = mainColor; ctx.lineWidth = 1.5;
    if(lvl === 1 || lvl === 1.618) ctx.setLineDash([]); else ctx.setLineDash([4, 4]);
    ctx.stroke();
    ctx.fillStyle = mainColor; ctx.font = isPreview ? "12px Arial" : "bold 14px Arial";
    let text = (lvl * 100).toFixed(1); if (text.endsWith('.0')) text = text.replace('.0', '');
    ctx.fillText(text, line.x2 + 5, yLevel - 5); 
  });
  ctx.setLineDash([]);
  if(labelIndex !== null) {
      const midX = (line.x1+line.x2)/2; const midY = (line.y1+line.y2)/2 - 20;
      ctx.save(); ctx.globalAlpha = 0.8; ctx.fillStyle = 'white';
      ctx.fillRect(midX - 15, midY - 25, 30, 30); ctx.restore();
      ctx.fillStyle = 'black'; ctx.font = "bold 30px Arial"; ctx.fillText(labelIndex, midX - 8, midY); 
  }
}

function checkAnswer() {
  const s = steps[currentStepIdx];
  if(!tempLine) { 
       document.getElementById('resultStatus').innerHTML = "<span style='color:#e67e22'>‚ö†Ô∏è ‡∏ß‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö</span>";
       return;
  }
  const margin = 15; 
  let isCorrect = false;
  
  if (s.type === 'vertical') {
     if(Math.abs(tempLine.x - s.answerX) < margin) isCorrect = true;
  } else {
     const u = tempLine; const a = s.answer;
     const directMatch = (Math.abs(u.y1 - a.y1) < margin && Math.abs(u.y2 - a.y2) < margin) && (Math.abs(u.x1 - a.x1) < margin && Math.abs(u.x2 - a.x2) < margin);
     const reverseMatch = (Math.abs(u.y1 - a.y2) < margin && Math.abs(u.y2 - a.y1) < margin) && (Math.abs(u.x1 - a.x2) < margin && Math.abs(u.x2 - a.x1) < margin);
     if (directMatch || reverseMatch) isCorrect = true;
  }

  if (isCorrect) {
    document.getElementById('resultStatus').innerHTML = "<span class='correct'>‚úÖ</span>";
    userLines.push({...tempLine, removed: false}); tempLine = null; 
    currentStepIdx++; draw(); setTimeout(() => { showStep(); }, 1000);
  } else {
    document.getElementById('resultStatus').innerHTML = "<span class='wrong'>‚ùå</span>";
  }
}

function showStep() {
  if(currentStepIdx >= steps.length) {
      document.getElementById('questionText').innerText = "üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å  ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö‡∏ú‡∏°!";
      document.getElementById('mainActions').style.display = 'none';
      document.getElementById('removePanel').style.display = 'none';
      draw(); return;
  }
  const s = steps[currentStepIdx];
  document.getElementById('questionText').innerText = s.question;
  document.getElementById('resultStatus').innerText = "";
  tempLine = null; draw();
  
  if (s.type === 'remove') {
    document.getElementById('removePanel').style.display = 'flex';
    document.getElementById('mainActions').style.display = 'none';
    const sel = document.getElementById('removeSelector'); 
    sel.innerHTML = "";
    userLines.forEach((l, i) => { 
       if(l.removed) return;
       // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏™‡πâ‡∏ô Vertical ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏ö
       if(l.type === 'vertical') return;

       const typeName = l.type === 'up' ? '‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô' : '‡∏Ç‡∏≤‡∏•‡∏á';
       sel.innerHTML += `<option value="${i}">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà ${i+1} (${typeName})</option>`; 
    });
  } else {
    document.getElementById('removePanel').style.display = 'none';
    document.getElementById('mainActions').style.display = 'block';
  }
}

function confirmRemove() {
    const idx = parseInt(document.getElementById('removeSelector').value);
    const s = steps[currentStepIdx];
    if (idx === s.removeIndex) {
        userLines[idx].removed = true; document.getElementById('resultStatus').innerHTML = "<span class='correct'>‚úÖ</span>";
        currentStepIdx++; draw(); setTimeout(() => { showStep(); }, 1000);
    } else { document.getElementById('resultStatus').innerHTML = "<span class='wrong'>‚ùå</span>"; }
}
</script>
</body>
</html>
